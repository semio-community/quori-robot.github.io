---
import BaseHead from "@/components/BaseHead.astro";
import SiteShell from "@/layouts/SiteShell.astro";
import HomePage from "@/react-pages/home/HomePage";

import "../styles/global.css";
import "../assets/fonts/Gilroy.css";

import { siteConfig } from "@/site.config";

import { getAllHardware } from "@/data/hardware";
import { getAllSoftware } from "@/data/software";
import { getAllResearch } from "@/data/research";
import {
  getCurrentEvents,
  getFeaturedEvents,
  getUpcomingEvents,
} from "@/data/events";
import { getEntry } from "astro:content";
import { isDraftVisible } from "@/utils/drafts";
import { resolveImageLike } from "@/utils/images";

// Load data on the server (Astro)
const allHardware = await getAllHardware();
const allSoftware = await getAllSoftware();
const allResearch = await getAllResearch();

const projectCount =
  allHardware.length + allSoftware.length + allResearch.length;

const now = new Date();
const currentEvents = await getCurrentEvents();
const upcomingEvents = await getUpcomingEvents();
const featuredOnly = await getFeaturedEvents();
const featuredEventCount = [
  ...currentEvents.filter((c) => !featuredOnly.some((f) => f.id === c.id)),
  ...upcomingEvents.filter((u) => !featuredOnly.some((f) => f.id === u.id)),
  ...featuredOnly.filter((f) => f.data.startDate > now),
].length;

const nsfEntry = await getEntry("organizations", "nsf");
const fundingPartner =
  nsfEntry && isDraftVisible(nsfEntry.data.draft)
    ? {
        id: nsfEntry.id,
        name: nsfEntry.data.name,
        shortName: nsfEntry.data.shortName,
        description: nsfEntry.data.description,
        collaborationSummary: nsfEntry.data.collaborationSummary,
        type: nsfEntry.data.type,
        category: nsfEntry.data.category,
        website: nsfEntry.data.links?.website,
        logoSrc: resolveImageLike(
          nsfEntry.data.images?.logo ?? nsfEntry.data.images?.logoUrl,
        ),
      }
    : null;

const pageTitle = "Home";
const description = siteConfig.description;
const ogImage = "/og/home.png";
---

<html
  class="overflow-x-hidden grid scroll-pt-[72px] scroll-smooth font-sans text-text text-xl md:text-base antialiased"
  lang={siteConfig.lang}
>
  <head>
    <BaseHead title={pageTitle} description={description} ogImage={ogImage} />
  </head>
  <body class="relative min-h-screen w-full bg-surface">
    <SiteShell noPaddingTop showBackground={false}>
      <HomePage
        client:load
        projectCount={projectCount}
        featuredEventCount={featuredEventCount}
        fundingPartner={fundingPartner}
      />
    </SiteShell>
  </body>
</html>
